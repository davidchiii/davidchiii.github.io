<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <!-- Start header --> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="David Chang" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="David Chang" /> <title> picoCTF21 - Shop Writeup - David Chang </title> <link rel="alternate" href="http://localhost:4000/pico21-shop/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/pico21-shop/" /> <meta name="description" content="Find a CTF. Find a Job." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="picoCTF21 - Shop Writeup | David Chang" /> <meta property="og:title" content="picoCTF21 - Shop Writeup | David Chang" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/pico21-shop/" /> <meta property="og:description" content="Find a CTF. Find a Job." /> <meta property="og:image" content="http://localhost:4000/assets/img/lab.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="picoCTF21 - Shop Writeup | twitter_username" /> <meta name="twitter:url" content="http://localhost:4000/pico21-shop/" /> <meta name="twitter:site" content="@twitter_username" /> <meta name="twitter:creator" content="@twitter_username" /> <meta name="twitter:description" content="Find a CTF. Find a Job." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/lab.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="David Chang" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/code-svgrepo-com.svg" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/code-svgrepo-com.svg" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/code-svgrepo-com.svg" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- for mathjax support --> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TRKVKDFM" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZFBBTM4N5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-0ZFBBTM4N5'); </script> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <!-- icon --> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <!-- icon --> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="fa-solid fa-code" style="color: #ff5277"> <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#go">GO</a>, <a class="tag" href="/tags/#reversing">REVERSING</a> </span> </div> <h1 class="header-title" itemprop="headline">picoCTF21 - Shop Writeup</h1> <div class="post-meta"> <time datetime="2024-05-24T19:07:00-04:00" itemprop="datePublished"> May 24, 2024 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">David Chang</span> </span> <time hidden datetime="" itemprop="dateModified"> May 24, 2024 </time> <span hidden itemprop="publisher" itemtype="Person">David Chang</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"> <div class="admonition question rounded"> <p class="admonition-title">Shop</p> <p> Best Stuff - Cheap Stuff, Buy Buy Buy... Store Instance: source. The shop is open for business at <code>nc mercury.picoctf.net 11371</code>. </p> </div> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <div class="admonition question rounded"> <p class="admonition-title">Shop</p> <p> Best Stuff - Cheap Stuff, Buy Buy Buy... Store Instance: source. The shop is open for business at <code>nc mercury.picoctf.net 11371</code>. </p> </div> <p>Upon first inspection, this is a <code class="language-plaintext highlighter-rouge">go</code> binary. According to some of my friends, it’s annoying to reverse (haha).</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scribbl@beepboop:~<span class="nv">$ </span>file <span class="nb">source
source</span>: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, Go <span class="nv">BuildID</span><span class="o">=</span>r5IKmnk_hVFErwy5ewa3/PyI570w85RI5Xa1aSnrW/RxmeFbAluXa5Hnisdodi/MJQIt60cZyLjm5Wta-r0, with debug_info, not stripped
</code></pre></div></div> <p>Loading it into IDA, we trace through <code class="language-plaintext highlighter-rouge">main()</code> without much success. There’s a <code class="language-plaintext highlighter-rouge">get_flag()</code> function that we can follow through the menu code.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// main.get_flag</span>
<span class="c1">// local variable allocation has failed, the output may be wrong!</span>
<span class="kt">void</span> <span class="n">__golang</span> <span class="n">__noreturn</span> <span class="nf">main_get_flag</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">filename</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-44h]</span>
  <span class="n">_DWORD</span> <span class="o">*</span><span class="n">filenamea</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-44h]</span>
  <span class="n">_BYTE</span> <span class="n">filename_4</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span> <span class="c1">// [esp+4h] [ebp-40h] OVERLAPPED</span>
  <span class="kt">int</span> <span class="n">elem</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// [esp+28h] [ebp-1Ch] BYREF</span>
  <span class="n">_DWORD</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// [esp+34h] [ebp-10h] BYREF</span>
  <span class="n">runtime_eface</span> <span class="n">a_8</span><span class="p">;</span> <span class="c1">// [esp+3Ch] [ebp-8h]</span>

  <span class="n">filename</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint8</span> <span class="o">*</span><span class="p">)</span><span class="s">"flag.txt"</span><span class="p">;</span>
  <span class="n">filename</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">retval_80D3040</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">io_ioutil_ReadFile</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">main_check</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">error</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
  <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
  <span class="n">a_8</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RTYPE_string_0</span><span class="p">;</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_statictmp_14</span><span class="p">;</span>
  <span class="n">a_8</span> <span class="o">=</span> <span class="n">runtime_convT2Eslice</span><span class="p">((</span><span class="n">runtime__type</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">RTYPE__slice_uint8_0</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
  <span class="n">filenamea</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">filename_4</span> <span class="o">=</span> <span class="mh">0x200000002LL</span><span class="p">;</span>
  <span class="n">fmt_Println</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_slice_interface_</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">filename_4</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]);</span>
  <span class="n">os_Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>However, where does the user even interact with the program? We need to look at where the function takes user input since at the end of the day, it’s our input that will make a difference.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span> <span class="n">wallet</span> <span class="o">&lt;</span> <span class="n">inv</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">v11</span><span class="p">].</span><span class="n">price</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">v35</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RTYPE_string_0</span><span class="p">;</span>
  <span class="n">v35</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">main_statictmp_7</span><span class="p">;</span>
  <span class="n">ai</span><span class="p">.</span><span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">interface_</span> <span class="o">*</span><span class="p">)</span><span class="n">v35</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ai</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x100000001LL</span><span class="p">;</span>
  <span class="n">fmt_Println</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="n">wallet</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
  <span class="n">inv</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">v11</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">v9</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">&gt;=</span> <span class="n">inv</span><span class="p">.</span><span class="n">len</span> <span class="p">)</span>
    <span class="n">runtime_panicindex</span><span class="p">();</span>
  <span class="n">v14</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span><span class="p">;</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="n">wallet</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">_num</span> <span class="o">*</span> <span class="n">inv</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">v14</span><span class="p">].</span><span class="n">price</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v10</span> <span class="o">&gt;=</span> <span class="n">user</span><span class="p">.</span><span class="n">len</span> <span class="p">)</span>
    <span class="n">runtime_panicindex</span><span class="p">();</span>
  <span class="n">user</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">v14</span><span class="p">].</span><span class="n">count</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">_num</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">inv</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">2u</span> <span class="p">)</span>
    <span class="n">runtime_panicindex</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">inv</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="n">main_get_flag</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">v13</span> <span class="o">=</span> <span class="n">v15</span><span class="p">;</span>
</code></pre></div></div> <p>In this block, we notice our wallet is being updated with the <code class="language-plaintext highlighter-rouge">price</code> of the object we’re buying multiplied by the amount we set in <code class="language-plaintext highlighter-rouge">_num</code>. However, it doesn’t validate any negative inputs. Thus, we can just buy a negative value to increase the amount of money we have in our wallet!</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scribbl@beepboop:~<span class="nv">$ </span>nc mercury.picoctf.net 11371
Welcome to the market!
<span class="o">=====================</span>
You have 40 coins
        Item            Price   Count
<span class="o">(</span>0<span class="o">)</span> Quiet Quiches       10      12
<span class="o">(</span>1<span class="o">)</span> Average Apple       15      8
<span class="o">(</span>2<span class="o">)</span> Fruitful Flag       100     1
<span class="o">(</span>3<span class="o">)</span> Sell an Item
<span class="o">(</span>4<span class="o">)</span> Exit
Choose an option:
0
How many <span class="k">do </span>you want to buy?
<span class="nt">-100000</span>
You have 1000040 coins
        Item            Price   Count
<span class="o">(</span>0<span class="o">)</span> Quiet Quiches       10      100012
<span class="o">(</span>1<span class="o">)</span> Average Apple       15      8
<span class="o">(</span>2<span class="o">)</span> Fruitful Flag       100     1
<span class="o">(</span>3<span class="o">)</span> Sell an Item
<span class="o">(</span>4<span class="o">)</span> Exit
Choose an option:
2
How many <span class="k">do </span>you want to buy?
1
Flag is:  <span class="o">[</span>112 105 99 111 67 84 70 123 98 52 100 95 98 114 111 103 114 97 109 109 101 114 95 98 56 100 55 50 55 49 102 125]
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">flag</span> <span class="o">=</span> <span class="s">"112 105 99 111 67 84 70 123 98 52 100 95 98 114 111 103 114 97 109 109 101 114 95 98 56 100 55 50 55 49 102 125"</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">)</span>
<span class="s">'picoCTF{b4d_brogrammer_b8d7271f}'</span>
</code></pre></div></div> </div> </article> <!-- unnecessary file, however you can still use for comment section, e.g disqus --> <script src="https://utteranc.es/client.js" repo="username/reponame" issue-term="pathname" label="✨ comment ✨" theme="github-light" crossorigin="anonymous" async ></script> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/on-leadership/" > <div class="nav-arrow">Previous</div> <span class="post-title">On Leadership and the Drive</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/about">about</a> <a class="footer_item" href="https://www.linkedin.com/in/davidchang52">linkedin</a> <a class="footer_item" href="https://github.com/davidchiii">github</a> <span class="footer_item">&copy; 2024</span> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
